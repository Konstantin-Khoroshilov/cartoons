<html>

<head>
  <title>Cartoons</title>
  <link rel="icon" type="image/x-icon" href="./assets/favicon.svg">
  <link rel="stylesheet" href="./index.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body>
  <div class="modal-window">
    <div class="playlist-container">
      <ul class="playlist list"></ul>
      <div class="control-panel">
        <div class="select-container">
          <label class="select-label select-label_type_name">
            Название
            <select class="select-cartoon" name="" id=""></select>
          </label>
          <label class="select-label select-label_type_season">
            Сезон
            <select class="select-season" name="" id=""></select>
          </label>
          <label class="select-label select-label_type_episode">
            Серия
            <select class="select-episode" name="" id=""></select>
          </label>
        </div>
        <div class="controls-contaier">
          <button class="button button_type_to-beginning" type="button"></button>
          <button class="button button_type_prev" type="button"></button>
          <button class="button button_type_play" type="button"></button>
          <button class="button button_type_next" type="button"></button>
          <button class="button button_type_to-end" type="button"></button>
        </div>
      </div>
    </div>
  </div>
</body>
<script>
  const selectCartoon = document.querySelector('.select-cartoon');
  const selectSeason = document.querySelector('.select-season');
  const selectEpisode = document.querySelector('.select-episode');
  const playlistEl = document.querySelector('.playlist');
  const toBegButton = document.querySelector('.button_type_to-beginning');
  const prevButton = document.querySelector('.button_type_prev');
  const playButton = document.querySelector('.button_type_play');
  const nextButton = document.querySelector('.button_type_next');
  const toEndButton = document.querySelector('.button_type_to-end');
  const playEvt = new Event('play');
  const playlist = [];
  let longestCartoonLength = 0;

  const chan = {
    cover: './assets/chan.webp',
    name: 'Приключения Джеки Чана',
    seasons: [13, 39, 17, 13, 13],
    episodes: [
      {
        season: '1',
        episode: '1',
        url: 'b8ff6309fafa356c5dcf1516bc79e87d',
      },
      {
        season: '1',
        episode: '2',
        url: '59ff3721ef8e9c670de3c308e1a898d6',
      },
      {
        season: '1',
        episode: '3',
        url: '95f4aabdec02b774750ed624ff473382',
      },
      {
        season: '1',
        episode: '4',
        url: '7373240457437b433515ef9aecfebe19',
      },
      {
        season: '1',
        episode: '5',
        url: '37bf70911667e918d8b34bfce869cd5a',
      },
      {
        season: '1',
        episode: '6',
        url: 'f0283378f779a448572f13512b02fd91',
      },
      {
        season: '1',
        episode: '7',
        url: 'b83140b93a7ea2289c7ae4c63b18fa38',
      },
      {
        season: '1',
        episode: '8',
        url: 'e43b88614e111289db938e1ef6f8b8f8',
      },
      {
        season: '1',
        episode: '9',
        url: '2672c37728cfc8007c3f978e24192a8d',
      },
      {
        season: '1',
        episode: '10',
        url: '2735ff7b6a862f6a22eafc59361e7584',
      },
      {
        season: '1',
        episode: '11',
        url: 'aeccc712383e01df5812c33e6d205629',
      },
      {
        season: '1',
        episode: '12',
        url: 'b9801721f9fb87ce231fca4a23df2d92',
      },
      {
        season: '1',
        episode: '13',
        url: '738ab3e9fb5b35c757ed0703f87db9ff',
      },
      {
        season: '2',
        episode: '1',
        url: '1b132b4d7817b7b560db6c6b3fdea725',
      },
      {
        season: '2',
        episode: '2',
        url: '0edb9d721f0443360848a72546e14dff',
      },
      {
        season: '2',
        episode: '3',
        url: 'f6f2d51a50646a5cea371aaffa7ab124',
      },
      {
        season: '2',
        episode: '4',
        url: 'a7f03397cfda493ed48eebc537b6653a',
      },
      {
        season: '2',
        episode: '5',
        url: '388e3b589e4ec3d6e754ae0a87ee71cf',
      },
      {
        season: '2',
        episode: '6',
        url: '35d1fa2c55194b459850cd3f144a3832',
      },
      {
        season: '2',
        episode: '7',
        url: 'cb1300a5b50ce725e95b525f3dd03e57',
      },
      {
        season: '2',
        episode: '8',
        url: 'b85365d19383875e77b65fc6d77d66ec',
      },
      {
        season: '2',
        episode: '9',
        url: '30b5d3a36313630082a22c8f8c917eb7',
      },
      {
        season: '2',
        episode: '10',
        url: 'e45d92159963d7e5576f218e56c79154',
      },
      {
        season: '2',
        episode: '11',
        url: '187932ae01a1ab81ca27d276b65bb3ab',
      },
      {
        season: '2',
        episode: '12',
        url: '9b3036ad7a7bb659caee99b84f409f69',
      },
      {
        season: '2',
        episode: '13',
        url: '6761171a54a66b29e16d8a6c71974748',
      },
      {
        season: '2',
        episode: '14',
        url: '34b914fa616932e5a43d1861d652be86',
      },
      {
        season: '2',
        episode: '15',
        url: 'f36fdeea23720da08a6ed0f3f802cb84',
      },
      {
        season: '2',
        episode: '16',
        url: '04583b1f91c2303aecb65e7f6523ae34',
      },
      {
        season: '2',
        episode: '17',
        url: '6d369481feb88df80ab0e86e648f9758',
      },
      {
        season: '2',
        episode: '18',
        url: 'd7e7cb5e0ee7130e97a14513e25b7389',
      },
      {
        season: '2',
        episode: '19',
        url: '7fa995643d15a3dcc37631746d878be9',
      },
      {
        season: '2',
        episode: '20',
        url: '161eb2bce1b85a3f6a7fab8d51d8c2c7',
      },
      {
        season: '2',
        episode: '21',
        url: 'c31252731b3968f7f67b9abc0cdc0029',
      },
      {
        season: '2',
        episode: '22',
        url: '8f47202343156a5e36f06ca1a72e1bf1',
      },
      {
        season: '2',
        episode: '23',
        url: '3de22007f14869ba35df975ced1e51f6',
      },
      {
        season: '2',
        episode: '24',
        url: '77dce42f4ed69f09f8ffdd52723d5932',
      },
      {
        season: '2',
        episode: '25',
        url: '514ca6dc7e33aa5da65d5d3f6c7867bc',
      },
      {
        season: '2',
        episode: '26',
        url: '1e4f9942c2fccedfa05de78fbc189932',
      },
      {
        season: '2',
        episode: '27',
        url: '18dffb66f716173caca9fdd2926c9ea4',
      },
      {
        season: '2',
        episode: '28',
        url: '37fa6c9d34b1d6d71425b15250330ae9',
      },
      {
        season: '2',
        episode: '29',
        url: 'e342e803ac921761658977a2df54b694',
      },
      {
        season: '2',
        episode: '30',
        url: '308f4c6fe2937e5bb1faaad36295f08d',
      },
      {
        season: '2',
        episode: '31',
        url: '6c62189bc231e9ff43c27f1ba9776f74',
      },
      {
        season: '2',
        episode: '32',
        url: 'f615e4c62e15ecad8148b88590e39afb',
      },
      {
        season: '2',
        episode: '33',
        url: '091e62f47f0f16f4ec07f1be1a05e325',
      },
      {
        season: '2',
        episode: '34',
        url: '569f33e03f753291365d512feb7a8972',
      },
      {
        season: '2',
        episode: '35',
        url: '40adc190d797c799a86cd9dcbd76472c',
      },
      {
        season: '2',
        episode: '36',
        url: 'cfccf9d4d9a4a7188e4645e9490e6f66',
      },
      {
        season: '2',
        episode: '37',
        url: '6efb2a57f5caf207b43b576aa838c4a3',
      },
      {
        season: '2',
        episode: '38',
        url: '7b9cb99f4b80dde4e1de9258830b6e1c',
      },
      {
        season: '2',
        episode: '39',
        url: '01d934da1be6c5a5c6676d2f40647f32',
      },
      {
        season: '3',
        episode: '1',
        url: '54d42a5c7b2c93b614522ad32a896eb4',
      },
      {
        season: '3',
        episode: '2',
        url: '5ffdda291636701bb6647d6850c63fc4',
      },
      {
        season: '3',
        episode: '3',
        url: '723a1d548d5a1e6ec20a4f3f2dc27e79',
      },
      {
        season: '3',
        episode: '4',
        url: '2a5b3a3a2dd633b36eed29f982e764bf',
      },
      {
        season: '3',
        episode: '5',
        url: 'dd96f7014bc27476aa568e936cabf6b0',
      },
      {
        season: '3',
        episode: '6',
        url: '845a0f1acb0b7053c7281aaedef4e750',
      },
      {
        season: '3',
        episode: '7',
        url: '009fc083931a04d36b88988262ee35c4',
      },
      {
        season: '3',
        episode: '8',
        url: 'd9a3976fb5021c79539652cd45f7d34a',
      },
      {
        season: '3',
        episode: '9',
        url: 'bd190cf2d1259885cb9359c4ee24b501',
      },
      {
        season: '3',
        episode: '10',
        url: '4866b4ee89d07d633b0600de32a26e9a',
      },
      {
        season: '3',
        episode: '11',
        url: 'bd9f9ac2b39567f7b14853610cf273c2',
      },
      {
        season: '3',
        episode: '12',
        url: '6698b29128405d9944ba4aa839912426',
      },
      {
        season: '3',
        episode: '13',
        url: '8767143bf85c9670e773bcb6b2131a7a',
      },
      {
        season: '3',
        episode: '14',
        url: 'eaf9093894f7df151122b2259d3ce0ea',
      },
      {
        season: '3',
        episode: '15',
        url: '314b561cc264c7b63752aa817bc08571',
      },
      {
        season: '3',
        episode: '16',
        url: 'e150306e5060425e19cc296b6a65db3d',
      },
      {
        season: '3',
        episode: '17',
        url: '641ab7484c3c63ee7a98c8bd170e87b6',
      },
      {
        season: '4',
        episode: '1',
        url: '238998730a06c31d55ce33cf30b7e83a',
      },
      {
        season: '4',
        episode: '2',
        url: 'e9066ef444a9117699a2fe9f8d38b96e',
      },
      {
        season: '4',
        episode: '3',
        url: '0f384d09c9bdd1e21f844245991d38c8',
      },
      {
        season: '4',
        episode: '4',
        url: '8694e2eab20dcc6f53032ff115fce9d6',
      },
      {
        season: '4',
        episode: '5',
        url: '237d63db60434c61beafa8f21f24ce34',
      },
      {
        season: '4',
        episode: '6',
        url: '1b529cb2fe854f0c2be5dc69fe9e924e',
      },
      {
        season: '4',
        episode: '7',
        url: '99e8ce75369a712ea1b9cd48d74fbd9e',
      },
      {
        season: '4',
        episode: '8',
        url: 'b203c483fa7754950bcb2e28e12fdb8a',
      },
      {
        season: '4',
        episode: '9',
        url: '72e5aa17b8e00dc276c8a5bde7377ae4',
      },
      {
        season: '4',
        episode: '10',
        url: '7d6d983f8b7fe601306c98faf310a715',
      },
      {
        season: '4',
        episode: '11',
        url: '94160ec3fc193ec05df454a711d9e370',
      },
      {
        season: '4',
        episode: '12',
        url: 'd838190085174d0e8556bc5015616599',
      },
      {
        season: '4',
        episode: '13',
        url: 'eb8118d42781e3b3424420182014d149',
      },
      {
        season: '5',
        episode: '1',
        url: '66d5ca4d4ffe90859eb36b1c59b2dda5',
      },
      {
        season: '5',
        episode: '2',
        url: 'eee7a240da2d5890015d4900d66699e3',
      },
      {
        season: '5',
        episode: '3',
        url: '977e829a8d7eb77b4ed85a1945f49f55',
      },
      {
        season: '5',
        episode: '4',
        url: '1ef952e266285ecc13f871497326dd0d',
      },
      {
        season: '5',
        episode: '5',
        url: '021eb820d2d323155f52be0f526042da',
      },
      {
        season: '5',
        episode: '6',
        url: '3beddbd70c872651b17f944572d31649',
      },
      {
        season: '5',
        episode: '7',
        url: 'd9f989d5f1d537c0e67d0d17eb305ed5',
      },
      {
        season: '5',
        episode: '8',
        url: '5232f7d81741559aead1f50beaafd279',
      },
      {
        season: '5',
        episode: '9',
        url: '8681ab9a8ca050939228b2cc28603de5',
      },
      {
        season: '5',
        episode: '10',
        url: '89c7a92b307db7c926be3a5447149f92',
      },
      {
        season: '5',
        episode: '11',
        url: 'ea3bb4f7c7e4ca6e6bbae89497e4caf2',
      },
      {
        season: '5',
        episode: '12',
        url: '247539dcce6921e1489ff54e024be61a',
      },
      {
        season: '5',
        episode: '13',
        url: 'dad546e0ff11935de01aba7cd829688c',
      },
    ],
  };

  const witch = {
    cover: './assets/witch.jpg',
    name: 'Чародейки',
    seasons: [1],
    episodes: [{
      season: '1',
      episode: '1',
      url: 'edea11e4ba3ce74e18d42bb1b3eb6147',
    }],
  };

  const beavers = {
    cover: './assets/beavers.webp',
    name: 'Крутые бобры',
    seasons: [1],
    episodes: [{
      season: '1',
      episode: '1',
      url: 'd1c62e58ff683653dcceca26f0ba6b9a',
    }],
  };

  const tuten = {
    cover: './assets/tutenstein.jpg',
    name: 'Тутенштейн',
    seasons: [1],
    episodes: [{
      season: '1',
      episode: '1',
      url: 'fc4144b75c6ce5f83800c096277265f3',
    }],
  };

  const kim = {
    cover: './assets/kim.jpg',
    name: 'Ким Пять-с-плюсом',
    seasons: [1],
    episodes: [{
      season: '1',
      episode: '1',
      url: 'c7fd158d9af2828a27dbf473a84964d3',
    }],
  };



  const cartoons = [chan, witch, beavers, tuten, kim];
  cartoons.forEach(cartoon => {
    if (cartoon.episodes.length > longestCartoonLength) {
      longestCartoonLength = cartoon.episodes.length;
    }
  });
  for (let i = 0; i < longestCartoonLength; i++) {
    cartoons.forEach(cartoon => {
      if (cartoon.episodes[i]) { playlist.push(cartoon.episodes[i]) }
    });
  }
  let currentEpisode = playlist[0];
  const storedIndex = JSON.parse(localStorage.getItem('currentVideoIndex'));
  let currentVideoIndex = storedIndex ? +storedIndex : 0;

  const fillSelect = (cartoon) => {
    cartoon.seasons.forEach((season, index) => {
      const seasonOption = document.createElement('option');
      seasonOption.value = index + 1 + '';
      seasonOption.text = index + 1 + '';
      selectSeason.append(seasonOption);
      selectSeason.addEventListener('change', () => {
        selectEpisode.textContent = '';
        for (let i = 1; i <= cartoon.seasons[+selectSeason.value - 1]; i++) {
          const episodeOption = document.createElement('option');
          episodeOption.value = i + '';
          episodeOption.text = i + '';
          selectEpisode.append(episodeOption);
        }
      });
      if (index === 0) {
        for (let i = 1; i <= season; i++) {
          const episodeOption = document.createElement('option');
          episodeOption.value = i + '';
          episodeOption.text = i + '';
          selectEpisode.append(episodeOption);
        }
      }
    });
  }

  cartoons.forEach(cartoon => {
    cartoon.episodes.forEach(episode => {
      episode.cartoonName = cartoon.name;
      episode.cartoonCover = cartoon.cover;
    })
  });

  fillSelect(cartoons[0]);

  selectCartoon.addEventListener('change', () => {
    selectSeason.innerHTML = ''
    selectEpisode.innerHTML = '';
    const cartoon = cartoons.find(cartoon => cartoon.name === selectCartoon.value);
    fillSelect(cartoon);
  });

  cartoons.forEach(cartoon => {
    const nameOption = document.createElement('option');
    nameOption.value = cartoon.name;
    nameOption.text = cartoon.name;
    selectCartoon.append(nameOption);
  });

  playlist.forEach((episode, index) => {
    const listItem = document.createElement('li');
    listItem.className = 'cartoon list__item';
    if (index === currentVideoIndex) { listItem.classList.add('list__item_active') }
    const cover = document.createElement('img');
    cover.className = 'cartoon__cover';
    cover.alt = `обложка мультика ${episode.cartoonName}`;
    cover.src = episode.cartoonCover;
    listItem.append(cover);
    const nameElem = document.createElement('p');
    nameElem.className = 'cartoon__name';
    nameElem.textContent = episode.cartoonName;
    listItem.title = episode.cartoonName;
    listItem.append(nameElem);
    const episodeElem = document.createElement('p');
    episodeElem.className = 'cartoon__episode-number';
    episodeElem.textContent = `Сезон ${episode.season}, серия ${episode.episode}`;
    listItem.append(episodeElem);
    playlistEl.append(listItem);
    listItem.addEventListener('play', () => {
      if (currentEpisode === episode) {
        document.querySelector('.list__item_active').classList.remove('list__item_active');
        listItem.classList.add('list__item_active');
      }
    });
    listItem.addEventListener('click', () => {
      if (currentVideoIndex !== index) {
        currentVideoIndex = index;
        play();
      }
    });
  });

  const playerContainer = document.createElement('div');
  playerContainer.className = 'player-container';
  const player = document.createElement('iframe');
  player.className = 'player';
  player.setAttribute('id', 'my-player');
  player.setAttribute('frameborder', '0');
  player.setAttribute('webkitAllowFullScreen', '');
  player.setAttribute('mozallowfullscreen', '');
  player.setAttribute('allowfullscreen', '');
  player.setAttribute('allow', 'clipboard-write; autoplay');
  player.src = `https://rutube.ru/play/embed/${playlist[currentVideoIndex].url}`;
  playerContainer.append(player);
  document.body.prepend(playerContainer);

  function doCommand(CommandJSON) {
    player.contentWindow.postMessage(JSON.stringify(CommandJSON), '*');
  }

  const play = () => {
    localStorage.setItem('currentVideoIndex', '' + currentVideoIndex);
    currentEpisode = playlist[currentVideoIndex];
    document.querySelectorAll('.list__item').forEach(elem => {
      elem.dispatchEvent(playEvt);
    });
    player.src = `https://rutube.ru/play/embed/${playlist[currentVideoIndex].url}`;
    do_play();
  }

  const playNext = () => {
    if (currentVideoIndex !== playlist.length - 1) {
      currentVideoIndex++;
    } else {
      currentVideoIndex = 0;
    }
    play();
  }

  const playPrev = () => {
    if (currentVideoIndex !== 0) {
      currentVideoIndex--;
    } else {
      currentVideoIndex = playlist.length - 1;
    }
    play();
  }

  const playFirst = () => {
    currentVideoIndex = 0;
    play();
  }

  const playLast = () => {
    currentVideoIndex = playlist.length - 1;
    play();
  }

  const playIndex = (index) => {
    currentVideoIndex = index;
    play();
  }

  function do_play() { doCommand({ type: 'player:play', data: { isFullscreen: true } }); }
  function do_pause() { doCommand({ type: 'player:pause', data: {} }); }
  function do_stop() { doCommand({ type: 'player:stop', data: {} }); }
  function do_setCurrentTime() { doCommand({ type: 'player:setCurrentTime', data: { time: 60 } }); }
  function do_relativelySeekRight() { doCommand({ type: 'player:relativelySeek', data: { time: 60 } }); }
  function do_relativelySeekLeft() { doCommand({ type: 'player:relativelySeek', data: { time: -60 } }); }
  function do_changeVideo() { doCommand({ type: 'player:changeVideo', data: { id: '33ad68e44dde6b3453ae4beaeaaf4c29' } }); }
  function do_setSkinColor() { doCommand({ type: 'player:setSkinColor', data: { color: 'FF00FF' } }); }
  function do_mute() { doCommand({ type: 'player:mute', data: {} }); }
  function do_unMute() { doCommand({ type: 'player:unMute', data: {} }); }
  function do_VolumeMid() { doCommand({ type: 'player:setVolume', data: { volume: 0.5 } }); }
  function do_VolumeUp() { doCommand({ type: 'player:setVolume', data: { change: 0.1 } }); }
  function do_VolumeDown() { doCommand({ type: 'player:setVolume', data: { change: -0.1 } }); }

  window.addEventListener("message", (event) => {
    if (event.data) {
      try {
        const data = JSON.parse(event.data);
        ev_type = data.type;
        ev_data = data.data;
      }
      catch (err) {
        ev_type = 'JSON invalid';
      };
      if (ev_type == 'player:ready') {
        do_play()
      }

      if (ev_type == 'player:changeState' && ev_data.state == 'stopped') {
        playNext();
      }
    }
  });

  toBegButton.addEventListener('click', playFirst);
  prevButton.addEventListener('click', playPrev);
  playButton.addEventListener('click', () => {
    const resIndex = playlist.findIndex((episode, index, array) => {
      return episode.cartoonName === selectCartoon.value && episode.season === selectSeason.value && episode.episode === selectEpisode.value;
    });
    if (resIndex === -1) {
      currentVideoIndex = 0;
      play();
    } else {
      currentVideoIndex = resIndex;
      play();
    }
  });
  nextButton.addEventListener('click', playNext);
  toEndButton.addEventListener('click', playLast);
</script>

</html>